<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  th:replace="~{layout :: layout(title='Users', content=~{::main})}"
>
  <main>
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h1 class="h3 mb-1">Users</h1>
        <p class="text-muted mb-0">Manage all registered users</p>
      </div>
    </div>

    <!-- Search and Filter -->
    <div class="search-filter-bar">
      <div class="row g-3 align-items-center">
        <div class="col-md-6">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input
              type="text"
              class="form-control"
              id="searchInput"
              placeholder="Search users..."
            />
          </div>
        </div>
        <div class="col-md-3">
          <select class="form-select" id="roleFilter">
            <option value="">All Roles</option>
            <option value="ADMIN">Admin</option>
            <option value="SELLER">Seller</option>
            <option value="CUSTOMER">Customer</option>
          </select>
        </div>
        <div class="col-md-3 text-end">
          <span class="text-muted" id="usersCount">0 users</span>
        </div>
      </div>
    </div>

    <!-- Users Table -->
    <div class="card">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody id="usersTable">
              <tr>
                <td colspan="5" class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Edit User Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit User</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <form id="editUserForm">
            <div class="modal-body">
              <input type="hidden" id="editUserId" />

              <div class="mb-3">
                <label for="editName" class="form-label">Username</label>
                <input
                  type="text"
                  class="form-control"
                  id="editName"
                  required
                  minlength="2"
                  maxlength="50"
                />
                <div class="invalid-feedback"></div>
              </div>

              <script src="/js/api.js"></script>
              <script src="/js/utils.js"></script>
              <script src="/js/users-list.js"></script>

  const userId = document.getElementById("editUserId").value;
  const userData = {
    name: document.getElementById("editName").value,
    email: document.getElementById("editEmail").value,
    role: document.getElementById("editRole").value,
  };

  const password = document.getElementById("editPassword").value;
  if (password) {
    userData.password = password;
  }

  try {
    await UsersApi.update(userId, userData);
    editModal.hide();
    Toast.success("User updated successfully");
    await loadUsers();
  } catch (error) {
    if (error.data && error.data.validationErrors) {
      Object.keys(error.data.validationErrors).forEach((field) => {
        const input = document.getElementById(
          "edit" + field.charAt(0).toUpperCase() + field.slice(1),
        );
        if (input) {
          input.classList.add("is-invalid");
          input.nextElementSibling.textContent =
            error.data.validationErrors[field];
        }
      });
    } else {
      Toast.error(error.message || "Failed to update user");
    }
  } finally {
    saveBtn.disabled = false;
    saveSpinner.classList.add("d-none");
  }
}

function deleteUser(userId, userName) {
  if (userId === UserManager.getUser().id) {
    Toast.error("You cannot delete your own account from here");
    return;
  }

  Confirm.show(
    "Delete User",
    `Are you sure you want to delete user "${userName}"? This action cannot be undone.`,
    async () => {
      try {
        await UsersApi.delete(userId);
        Toast.success("User deleted successfully");
        await loadUsers();
      } catch (error) {
        Toast.error(error.message || "Failed to delete user");
      }
    },
  );
}
</script>
</html>

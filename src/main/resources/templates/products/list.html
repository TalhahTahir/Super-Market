<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{layout :: layout(title='Products', content=~{::main})}">
<main>
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Products</h1>
            <p class="text-muted mb-0">Browse and manage products</p>
        </div>
        <div data-role="ADMIN,SELLER">
            <button class="btn btn-primary" onclick="openCreateModal()">
                <i class="bi bi-plus-circle me-2"></i>Add Product
            </button>
        </div>
    </div>

    <!-- Search and Filter -->
    <div class="search-filter-bar">
        <div class="row g-3">
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search products...">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="categoryFilter">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="storeFilter">
                    <option value="">All Stores</option>
                </select>
            </div>
            <div class="col-md-2 text-end">
                <span class="text-muted" id="productsCount">0 products</span>
            </div>
        </div>
    </div>

    <!-- View Toggle -->
    <div class="d-flex justify-content-end mb-3">
        <div class="btn-group btn-group-sm" role="group">
            <button type="button" class="btn btn-outline-secondary active" id="gridViewBtn" onclick="setView('grid')">
                <i class="bi bi-grid"></i>
            </button>
            <button type="button" class="btn btn-outline-secondary" id="listViewBtn" onclick="setView('list')">
                <i class="bi bi-list"></i>
            </button>
        </div>
    </div>

    <!-- Products Grid View -->
    <div class="row g-4" id="productsGrid">
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <!-- Products List View -->
    <div class="card d-none" id="productsListCard">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Category</th>
                            <th>Store</th>
                            <th>Price</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="productsTable">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Product Modal (Create/Edit) -->
    <div class="modal fade" id="productModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalTitle">Add Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="productForm">
                    <div class="modal-body">
                        <input type="hidden" id="productId">
                        
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label for="productName" class="form-label">Product Name</label>
                                <input type="text" class="form-control" id="productName" required 
                                       minlength="2" maxlength="100" placeholder="Enter product name">
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-4">
                                <label for="productPrice" class="form-label">Price</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" id="productPrice" required 
                                           min="0.01" step="0.01" placeholder="0.00">
                                </div>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-1">
                            <div class="col-md-6">
                                <label for="productCategory" class="form-label">Category</label>
                                <select class="form-select" id="productCategory" required>
                                    <option value="">Select category</option>
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>
                            <div class="col-md-6">
                                <label for="productStore" class="form-label">Store</label>
                                <select class="form-select" id="productStore" required>
                                    <option value="">Select store</option>
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <label for="productDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="productDescription" rows="3" 
                                      maxlength="500" placeholder="Enter product description (optional)"></textarea>
                            <small class="text-muted"><span id="descCharCount">0</span>/500 characters</small>
                            <div class="invalid-feedback"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="saveProductBtn">
                            <span class="spinner-border spinner-border-sm d-none me-2" id="saveProductSpinner"></span>
                            Save Product
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div class="modal fade" id="productDetailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productDetailTitle">Product Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="productDetailBody">
                    <!-- Content loaded dynamically -->
                </div>
                <div class="modal-footer" id="productDetailFooter">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</main>

<script th:inline="javascript">
    let allProducts = [];
    let allStores = [];
    let currentView = 'grid';
    let productModal, productDetailModal;

    document.addEventListener('DOMContentLoaded', async function() {
        // Check authentication
        if (!requireAuth()) return;

        // Initialize modals
        productModal = new bootstrap.Modal(document.getElementById('productModal'));
        productDetailModal = new bootstrap.Modal(document.getElementById('productDetailModal'));

        // Populate categories dropdown
        populateCategorySelects();

        // Load data
        await loadData();

        // Apply URL filters
        applyUrlFilters();

        // Setup search and filter
        document.getElementById('searchInput').addEventListener('input', debounce(filterProducts, 300));
        document.getElementById('categoryFilter').addEventListener('change', filterProducts);
        document.getElementById('storeFilter').addEventListener('change', filterProducts);

        // Handle form submission
        document.getElementById('productForm').addEventListener('submit', handleSaveProduct);

        // Description character count
        document.getElementById('productDescription').addEventListener('input', function() {
            document.getElementById('descCharCount').textContent = this.value.length;
        });

        // Check if we need to open create modal
        if (UrlParams.get('action') === 'new') {
            openCreateModal();
        }
    });

    function populateCategorySelects() {
        const categoryOptions = ProductCategories.map(cat => 
            `<option value="${cat}">${formatCategory(cat)}</option>`
        ).join('');

        document.getElementById('productCategory').innerHTML = '<option value="">Select category</option>' + categoryOptions;
        document.getElementById('categoryFilter').innerHTML = '<option value="">All Categories</option>' + categoryOptions;
    }

    async function loadData() {
        try {
            // Load products and stores in parallel
            [allProducts, allStores] = await Promise.all([
                ProductsApi.getAll(),
                StoresApi.getAll()
            ]);

            // Populate store filter
            document.getElementById('storeFilter').innerHTML = '<option value="">All Stores</option>' + 
                allStores.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

            // Populate store select in form
            const user = UserManager.getUser();
            let availableStores = allStores;
            
            // If seller, only show their stores
            if (user.role === 'SELLER') {
                availableStores = allStores.filter(s => s.managerId === user.id);
            }
            
            document.getElementById('productStore').innerHTML = '<option value="">Select store</option>' + 
                availableStores.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

            renderProducts(allProducts);
        } catch (error) {
            console.error('Error loading data:', error);
            Toast.error('Failed to load products');
        }
    }

    function applyUrlFilters() {
        const categoryParam = UrlParams.get('category');
        const storeIdParam = UrlParams.get('storeId');

        if (categoryParam) {
            document.getElementById('categoryFilter').value = categoryParam;
        }
        if (storeIdParam) {
            document.getElementById('storeFilter').value = storeIdParam;
        }

        if (categoryParam || storeIdParam) {
            filterProducts();
        }
    }

    function filterProducts() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const categoryFilter = document.getElementById('categoryFilter').value;
        const storeFilter = document.getElementById('storeFilter').value;

        let filtered = allProducts;

        if (search) {
            filtered = filtered.filter(product => 
                product.name.toLowerCase().includes(search) || 
                (product.description && product.description.toLowerCase().includes(search))
            );
        }

        if (categoryFilter) {
            filtered = filtered.filter(product => product.category === categoryFilter);
        }

        if (storeFilter) {
            filtered = filtered.filter(product => product.storeId === parseInt(storeFilter));
        }

        renderProducts(filtered);
    }

    function setView(view) {
        currentView = view;
        
        document.getElementById('gridViewBtn').classList.toggle('active', view === 'grid');
        document.getElementById('listViewBtn').classList.toggle('active', view === 'list');
        
        document.getElementById('productsGrid').classList.toggle('d-none', view === 'list');
        document.getElementById('productsListCard').classList.toggle('d-none', view === 'grid');

        // Re-render with current filtered products
        filterProducts();
    }

    function renderProducts(products) {
        document.getElementById('productsCount').textContent = `${products.length} product${products.length !== 1 ? 's' : ''}`;

        if (currentView === 'grid') {
            renderProductsGrid(products);
        } else {
            renderProductsList(products);
        }
    }

    function renderProductsGrid(products) {
        const grid = document.getElementById('productsGrid');

        if (products.length === 0) {
            grid.innerHTML = `
                <div class="col-12">
                    <div class="empty-state">
                        <i class="bi bi-box-seam"></i>
                        <h4>No products found</h4>
                        <p>Try adjusting your search or filters.</p>
                    </div>
                </div>
            `;
            return;
        }

        const user = UserManager.getUser();

        grid.innerHTML = products.map(product => {
            const store = allStores.find(s => s.id === product.storeId);
            const canEdit = user.role === 'ADMIN' || (store && store.managerId === user.id);

            return `
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="card product-card h-100" onclick="viewProductDetails(${product.id})">
                        <div class="card-img-top">
                            <i class="bi bi-box-seam"></i>
                        </div>
                        <div class="card-body">
                            <span class="badge ${getCategoryBadgeClass(product.category)} badge-category mb-2">
                                ${formatCategory(product.category)}
                            </span>
                            <h6 class="card-title mb-1">${product.name}</h6>
                            <p class="text-muted small mb-2 text-truncate-2">
                                ${product.description || 'No description'}
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="product-price">${formatCurrency(product.price)}</span>
                                <small class="text-muted">${store ? store.name : '-'}</small>
                            </div>
                        </div>
                        ${canEdit ? `
                        <div class="card-footer bg-transparent border-0 pt-0">
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary flex-grow-1" 
                                        onclick="event.stopPropagation(); openEditModal(${product.id})">
                                    <i class="bi bi-pencil me-1"></i>Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger" 
                                        onclick="event.stopPropagation(); deleteProduct(${product.id}, '${product.name}')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderProductsList(products) {
        const tbody = document.getElementById('productsTable');

        if (products.length === 0) {
            tbody.innerHTML = TableHelper.renderEmpty('No products found');
            return;
        }

        const user = UserManager.getUser();

        tbody.innerHTML = products.map(product => {
            const store = allStores.find(s => s.id === product.storeId);
            const canEdit = user.role === 'ADMIN' || (store && store.managerId === user.id);

            return `
                <tr class="cursor-pointer" onclick="viewProductDetails(${product.id})">
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div class="rounded bg-light p-2">
                                <i class="bi bi-box-seam text-muted"></i>
                            </div>
                            <div>
                                <strong>${product.name}</strong>
                                <br>
                                <small class="text-muted">${product.description ? product.description.substring(0, 50) + '...' : 'No description'}</small>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="badge ${getCategoryBadgeClass(product.category)}">
                            ${formatCategory(product.category)}
                        </span>
                    </td>
                    <td>${store ? store.name : '-'}</td>
                    <td class="text-primary fw-bold">${formatCurrency(product.price)}</td>
                    <td class="text-end" onclick="event.stopPropagation()">
                        ${canEdit ? `
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="openEditModal(${product.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteProduct(${product.id}, '${product.name}')">
                            <i class="bi bi-trash"></i>
                        </button>
                        ` : `
                        <button class="btn btn-sm btn-outline-secondary" onclick="viewProductDetails(${product.id})">
                            <i class="bi bi-eye"></i>
                        </button>
                        `}
                    </td>
                </tr>
            `;
        }).join('');
    }

    function openCreateModal() {
        document.getElementById('productModalTitle').textContent = 'Add Product';
        document.getElementById('productId').value = '';
        document.getElementById('productName').value = '';
        document.getElementById('productPrice').value = '';
        document.getElementById('productCategory').value = '';
        document.getElementById('productStore').value = '';
        document.getElementById('productDescription').value = '';
        document.getElementById('descCharCount').textContent = '0';

        // Clear validation errors
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

        productModal.show();
    }

    function openEditModal(productId) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) return;

        document.getElementById('productModalTitle').textContent = 'Edit Product';
        document.getElementById('productId').value = product.id;
        document.getElementById('productName').value = product.name;
        document.getElementById('productPrice').value = product.price;
        document.getElementById('productCategory').value = product.category;
        document.getElementById('productStore').value = product.storeId;
        document.getElementById('productDescription').value = product.description || '';
        document.getElementById('descCharCount').textContent = (product.description || '').length;

        // Clear validation errors
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

        productModal.show();
    }

    async function handleSaveProduct(e) {
        e.preventDefault();

        const saveBtn = document.getElementById('saveProductBtn');
        const saveSpinner = document.getElementById('saveProductSpinner');

        // Clear validation errors
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

        saveBtn.disabled = true;
        saveSpinner.classList.remove('d-none');

        const productId = document.getElementById('productId').value;
        const productData = {
            name: document.getElementById('productName').value,
            price: parseFloat(document.getElementById('productPrice').value),
            category: document.getElementById('productCategory').value,
            storeId: parseInt(document.getElementById('productStore').value),
            description: document.getElementById('productDescription').value || null
        };

        try {
            if (productId) {
                await ProductsApi.update(productId, productData);
                Toast.success('Product updated successfully');
            } else {
                await ProductsApi.create(productData);
                Toast.success('Product created successfully');
            }
            
            productModal.hide();
            await loadData();
        } catch (error) {
            if (error.data && error.data.validationErrors) {
                Object.keys(error.data.validationErrors).forEach(field => {
                    const fieldMap = { name: 'productName', price: 'productPrice', category: 'productCategory', storeId: 'productStore', description: 'productDescription' };
                    const input = document.getElementById(fieldMap[field] || field);
                    if (input) {
                        input.classList.add('is-invalid');
                        const feedback = input.closest('.mb-3, .col-md-4, .col-md-6, .col-md-8, .mt-3')?.querySelector('.invalid-feedback');
                        if (feedback) {
                            feedback.textContent = error.data.validationErrors[field];
                        }
                    }
                });
            } else {
                Toast.error(error.message || 'Failed to save product');
            }
        } finally {
            saveBtn.disabled = false;
            saveSpinner.classList.add('d-none');
        }
    }

    function viewProductDetails(productId) {
        const product = allProducts.find(p => p.id === productId);
        if (!product) return;

        const store = allStores.find(s => s.id === product.storeId);
        const user = UserManager.getUser();
        const canEdit = user.role === 'ADMIN' || (store && store.managerId === user.id);

        document.getElementById('productDetailTitle').textContent = product.name;
        
        document.getElementById('productDetailBody').innerHTML = `
            <div class="row">
                <div class="col-md-5">
                    <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 250px;">
                        <i class="bi bi-box-seam text-muted" style="font-size: 5rem;"></i>
                    </div>
                </div>
                <div class="col-md-7">
                    <span class="badge ${getCategoryBadgeClass(product.category)} mb-2">
                        ${formatCategory(product.category)}
                    </span>
                    <h3 class="mb-2">${product.name}</h3>
                    <p class="text-muted mb-3">Product ID: #${product.id}</p>
                    
                    <div class="mb-3">
                        <span class="h2 text-primary">${formatCurrency(product.price)}</span>
                    </div>
                    
                    <div class="mb-3">
                        <label class="text-muted small">Description</label>
                        <p class="mb-0">${product.description || 'No description provided.'}</p>
                    </div>
                    
                    <div class="mb-3">
                        <label class="text-muted small">Store</label>
                        <p class="mb-0">
                            <i class="bi bi-building text-primary me-2"></i>
                            ${store ? store.name : 'Unknown'}
                            ${store ? `<br><small class="text-muted ms-4">${store.location}</small>` : ''}
                        </p>
                    </div>
                </div>
            </div>
        `;

        document.getElementById('productDetailFooter').innerHTML = `
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            ${canEdit ? `
            <button type="button" class="btn btn-outline-primary" onclick="productDetailModal.hide(); openEditModal(${product.id})">
                <i class="bi bi-pencil me-2"></i>Edit Product
            </button>
            ` : ''}
        `;

        productDetailModal.show();
    }

    function deleteProduct(productId, productName) {
        Confirm.show(
            'Delete Product',
            `Are you sure you want to delete "${productName}"? This action cannot be undone.`,
            async () => {
                try {
                    await ProductsApi.delete(productId);
                    Toast.success('Product deleted successfully');
                    await loadData();
                } catch (error) {
                    Toast.error(error.message || 'Failed to delete product');
                }
            }
        );
    }
</script>
</html>
